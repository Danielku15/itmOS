#include <stdio.h>
#include <string.h>

#include "HAL/Timer/HalTimerDriver.h"
#include "Kernel/Task/TaskManager.h"
#include "Kernel/Interrupt/Handler/IRQHandler.h"
#include "Kernel/Interrupt/Handler/SWIHandler.h"
#include "Kernel/SystemCalls/SystemCallExec.h"

#include "Apps/Shell/Shell.h"

#include "Lib/Rand.h"
#include "Lib/Time.h"

#include "Apps/Shell/Shell.h"

#include "Kernel/Kernel.h"

#include "API/serviceCalls.h"

#include "OMAP-Lib/OMAP/McBSP2.h"

#include "Kernel/Task/Task.h"
#include "MMU/mmu.h"

#include "Loader/Loader.h"
#include "Messaging/MemoryManager/MemoryManager.h"
#include "Messaging/MessageQueue/MessageQueue.h"
#include "Messaging/Message/Message.h"

Kernel* kernel;

void ledOff(void) {
//	HalLedDriver driver;
//	driver.ledOff(LED1);
//	driver.ledOff(LED2);
}

void initScheduler(IRQHandler* hand) {
	srand_(time_());
	hand->registerHandler(HalTimerDriver::irqNumberForTimer(GPTIMER2), ledOff);

	HalTimerDriver::init(GPTIMER2, GPT_IRQMODE_OVERFLOW, 100);
	HalTimerDriver::start(GPTIMER2);

}

void dummy(IRQHandler* hand)  {
	initScheduler(hand);
	_enable_interrupts();
	asm("\t CPS 0x10");
	while(1);
}

void task1function() {
	int i = 0;
	for (i = 0; i < 10000; i++) {
//		HalLedDriver driver;
//		driver.toggle(LED1);
		for (int z = 0; z < 80000;) {
			z++;
		}
	}
}

void task2function() {
	int i = 0;
	for (i = 0; i < 100; i++) {
//		HalLedDriver driver;
//		driver.toggle(LED2);
		for (int z = 0; z < 80000;) {
			z++;
		}
	}	
}

void shellstart() {
	shell(kernel->getTaskManager());
}

void init_kernel() {
	kernel = new Kernel();
}

void audio_test() {
	McBSP2* mcbsp2 = new McBSP2();
	mcbsp2->init_mcbsp2();
}

void shell_test() {
	TaskManager* taskmanager = kernel->getTaskManager();
	taskmanager->create("shell\0", 100, (int)shellstart, false);
}

void tasks_test() {
	TaskManager* taskmanager = kernel->getTaskManager();
	
	// Register and start LED Service
	kernel->startService(LED_SERVICE);

	taskmanager->create("dummy\0", 0, (int)dummy, false);
	taskmanager->create("led 1\0", 70, (int)task1function, false);
	taskmanager->create("led 2\0", 30, (int)task2function, false);
	
	// Start User-Test-Task
//	taskmanager->create("User-Test-Task\0", 100, (int)userTask_main, false);
	
	// Shell-Tests
	shell_test();
	
	dummy(kernel->getHandlerManager()->getIrqHandler());
}

void loader_test() {
	Loader* loader = kernel->getLoader();
	loader->parse(":201000001400083C08080400000008040008EC00E8003C08CC0000090C0C05000404050435:201080001E040000F2001E8010000C0010000A0004050000040003060204000004F0000454:201100001070001812000000B6F0003C0B0704E000FF0000D803003C00700304F405B4060D:20118000080506040400BF00000100003C0470700060700000008838003C30040403000746:20120000030001000403F8FF03040036F0810001310001000404050000008C0000008C00C6:20128000000A0006056D00000C040003140006066200000C0409065B055900000C000C083F:20130000060063003C70F80004000103017200560000029A00F8000026B0003C00B40B8604:201380000704003201093E092F7C84000601040004168C140C0904101A0803010007001362:20140000010005040400051E1B083500000807068B075B003C05B63CBA0908090100050430:201480000401000449003C07F8F000010131086802050003010A003D0000C428003C0B07A0:2015000004182000050016040A000C04070C09080103070C08FA00040200EB010003003CE8:2015800000F0B001070004020A00BB08000C0003090400B2003C07F0109004C40000100354:201600002100100104FC10A4709C98A0A86CF8000102160A8413003C7C7485000000090719:201680000618043C00003C05F83C00F870000000041C1CFF040100700406D50028F50470EF:201700007F003A001C000F000D0108010805F0000D0DD8000100008C007F1C6800003C0D06:20178000DE0020003C4400003C041C3E240004003C04CC000DC9000503003C003E2404007D:201800003C00003C053EBC1000003C049EA400000400003C04103C0010F8000102160A58AC:2018800013003C50488500000009070614043C00003C05F83C00F8F800083C0000000EF4C7:20190000F400FF0108FCC8C8FF012801FB00A0003C08FC0100E07C003C788C18FF0C005C1F:2019800003003C00FC0008F405CC0D5300BA8C0607060C003C00000000060087050004BAEE:201A00000201BA3C07FCF8000102160AA413003C9C94850000000907061C043C00003C0554:201A8000F83C00F80670000C0A3009003C288400180003003C007010043C00010006BA0C89:201B0000AC8CBA0000003C0570F8030201006798003C9898FF06007C03003C00F80028F4E5:201B8000060508DB201424001828081C2C102030BA24000C3C05F8A4A828D828B0BC407854:201C000000140C0804000018010548039940039608049E0804019A0804028B0C00110804AA:201C800003840804048B0804087C0004001C77040004001C7C14000E080400008800044C55:201D0000A000CC0118044CA01F00001C0008205F00380400300800280C0020100018147018:201D8000000C0400040800FC0C00F41000EC146000E00400D80800D00C00C81000C014501F:201E000000B40400AC0800A40C009C100094144000880400800800780C007010006814304E:201E8000005C04005408004C0C004410003C14200018019B01A901B701C501D301E11108BF:201F000000F0003B120800DC00350C0800C4102F060407EA8EEE01F2000E080000081E08A6:201F80000000000300F30064080800001C0110000C00081E0800001C0110001000081E0805:20200000000008001CB6080E000004002000060014001CB304050008001CAC04040E0010C4:2020800008343C949038343C949038343C949038343C949038343C949038343C949038145C:20210000A8E03800003CD004BB010405F669B4050479A8003C04AD00040038F87402010055:20218000003C0146580107F3010004052502034700045800010C0C14003C4404F8F03800C1:20220000003CE0057F010504F52D00043E00010C0CAC003C4404388800103C0078F80204E5:202280001600042702000C030C010044003C04103020010000643C040D43044801050D3D6A:202300000542E0040D05F70104ED0005FE00010C0CAC003C44046430F880020100003C01FF:2023800046640001F201020004250203CA0704DB00010C0C20003C4404F8F8F80201000017:202400003C45E0070100022603FA010704F0A80004B900010C0C98003C44000405F8F8683B:20248000020100003C4750000125F40200020604032504250546077F00049003000C020C6B:202500000100E8003C04F8C83800003C00B445F1020004016200047300010C0C80003C447B:2025800004385C00103C004CF902044B00045C02000C030C010018003C0410A4B028A808AF:2026000000000400540254040106005801040401F8081E0800000720081E080000E000F252:202680000808040000040C081E08000080F208080000BFEC0808000000E6080804000004AD:20270000FF0000044C04081E080400000420081E08B40000B40C000C00B40C000C081E0868:20278000B40009000C040C08000C040C03B400F2F6081E080400FF000C080CFF081E0F0018:202800000400000C800C000C400CB000C2B200CE0014DF0400101E080400000408081E0867:202880000000081008081E080000104010081E0800000004081E080000101010081E0C8048:20290000080804000053006600006F0C00C804000008AA0004710880081E080000140104AD:202980000400000001081E0800001420040400000001081E08040004000000081E0804005F:202A000000040000081E3801C847C4000100000B62020162002B02012B000C01000E000039:202A8000067210047761200001618001000C0101000C40010C001402610D110205030D00BC:202B0000020A0002010106040002010182BC82000001003804389C00703C90042D880100D0:202B80000208180002042300010CF654003C707034020100003C0412050406891000003C0A:202C00000470FC100000070100E407000118FCC00000000601B818010101FA0A0010007C02:202C8000800002010418000012041038440100003CCF0004054F2800003C0438AC58B6A491:202D0000C088A8B808A8001C040004B40801140914080C0C140100140114049E140CF00831:202D800000100604950C01001E041000F501FF1C000E080C00000F0800000004EC00E8EC37:202E00000000BACC0100FF0E0014080400B40C0010100400100CCF00FB0C08D71001100820:202E80000108041000EE14000014080400340C00101004000F0CA200FB10080C0CBE1001D8:202F000010041000EF10140008000100BC0000A00008080000FE0008080000000300F20002:202F80006B0808006000081E080DDC0D920DE2080830E72C2C20990884787C8000B800A021:203000009CB8080000B40000040F002AC00000C40000C800080800000404000808000000EF:203080000300F10027080E04000004049F0E0E000004BE000207001A0004B600FA0004D4C7:2031000000040004CA040E0E04000053001300C8000C04180000C8C0000400C801C8020044:2031800000C80E0E00002400020700E6001D00FB00C4000C180400C4000C00180000C0C4C8:20320000000400C401C4020000C4040E08000000C8C4000800C4000C180001010000081E9D:2032800008000000C8C4000800C4000C180001010000081EF8001C040000680008200400D6:2033000001000E0008AC0808080108080408000900510820000800010804000C2C0C0004D6:20338000080C00B7100C100C14000C00040C00040814000C0F140C04001A000004040C1459:20340000000C01140C040C0018140018080018100C0018011B000004040414000CE60000A9:203480000404040C0C10000CDB14001814000418E4000C040C00000804000CBD00040000DC:20350000085200100400040800081C000E0804000E0400041E0F04002C190A04000414053C:203580000800ED01F0F40E0800007000009504BC00962CB800080800002CBE0004BB00083B:20360000080000000300EE00C3080800081E00340400040008B508B8089F340000340400EC:20368000040008A708B0089134000034040004000899089608833400003404000400088BE9:20370000089A300874303400E8001C040004310808000C08040D1A000C04C01F000C04ADBF:203780001A000C04C415080810000C04CA14001072090D00EB01E401DD01EAFF1C000800C4:20380000CB00C00000045F0008080000046700C40008080000000300EF00310808005400E4:20388000081E005C0DD70D570DDE5C00081CCD18180C5D0888009024B8F00001015F000C34:2039000047080C04BF14000704003100003F1406070607020C040A092C0006090A04260434:2039800001010809043608090C08090401000A05FB000C08000C140D201400D11000000D3A:203A000000060409000414011400F00007F108F0382405A400050CA00404380AD8001E018F:203A8000032B032F10081010181810FB1010010C0D0C1003040401060808010208080101C6:203B00000402010101B2B20100B2B20101010101010103F9011302CB040704B423B204F95A:203B8000040102B2B202010101010409040423032302230104F50401010101FB010800101B:203C000000390024001C0000080800001F0008080000000300F20034080800B4081E0800D1:203C8000B4081E0E000004049804A200040480049C0004046C0496000404580490000404C4:203D000044048A0004043004840E4C5369006C88A8343C90947000020110E530000000240F:203D8000072000000104080C0000000170000801E30008F0CC000000F005000C0C0B0000AA:203E00000804003C04E800050C00040000EBF000E17000020110A9400000003407300000C6:203E80000104080C0000000170B4B03C4C44001E1E001E981E041E0004040000010C1E0003:203F000004040100000C1E04040000010C1E1E001E7A1E1E001E751E1E001E701E1E001E92:203F80006B1E1E001E661E1E001E611E1E001E5C1E1E001E571E1E001E521E1E001E4D1E63:20400000BC9000464424DB000D732400200000003C000C0D3C0DB80D1B3C1001282E0F3C9B:204080001000282844000010944024B6000D5A94000000003C000C043C04940DF73C100152:20410000280A0F3C10002828400010736E6F6F696C736E6F6900C00014040000000C100C25:204180000C0900001008042C0200014800000C100C08082C0C000C080004000C080C0C00C3:204200000C040C000700040104000C040C000004010C0C0803040C89001001101400100050:2042800000010414100301140010800300024F14200002402014040006040407040124000D:204300000C000010011000080114032001021400081000024010140400050403070104007F:2043800000000108F8000001010203290401002504000C1408020176140008100C080400D9:204400001400010100010701000C140E0105310014140401140400F80814000100040110A9:20448000080C10080000F8AC580014080400040F0C00850C0002040C150C03B30018AC0E69:2045000000760018AC0018000500001818AC0C0C00015610FF080005006B0800108D0100CC:2045800000CE001004000C1800081614001000000111140020040800080503030C010E143F:2046000000010214001040043014100800100070F816003C600000000B054C18010307CC5E:204680000500010CF524003C01C20005F8A488A8A810180C08040004520800010068044B21:20470000080C10100C00010C100004000B08100C740000C6000800C2120010002A000C00AD:20478000E40004C70800100402001095001810FC0401330020022002A020201CA017201222:20480000A00D2008A003820E82020E02820E82020E02820E82020E02820E82020E0202226C:20488000E40E000102041E000001041E1E0E040000C00000040004FE000E080000049A0034:2049000008080000000300F100020808000004AE080800000492080800000497080800006E:2049800004A40828080400081E080000B00000081E080000081E080000000300F300CD082E:204A00000E000000000C3C0404A30800000800083C0800F3080008043CEDA01F080400003E:204A80000414000100800004140C0800040004140C08080019000E0400000A0400080C00CC:204B000004140C080C042D0008140C0C000CB200001F100C08040000B40000040400080827:204B8000000C0C00101E080000081E080000000300F300580808000004081E0800000808F9:204C00001E0800000C081E180E08040000AA04000100EE0004180005000004140B18080009:204C80000F04100C0004140001040100140001000504000200004A04000000010E0E00013B:204D000000C8006100F900080404001804010400040C000700000401040C042A0004040CD2:204D800000F10400E60004000008290000080000040EF0B00124B0B0B007060300040401FB:204E0000E8F67878070204E1FAF0110403070403040404FB0403010101FB0304020400EAC3:204E80001EFFCCD4708058080400000400011200081E080400000400011200081E0804006F:204F0000000400011200081E0804000004000112000001081E10080400101E080010005B4D:204F800000460090000008080000410008080000000300F2005608080028081E08002808F9:205000001E0800081E5361656334A00E00009600250000100C0C0104042C080008080004B2:205080000008080C0800000401080C04030C0C001001100200000C0E000201030103070066:20510000010103FB00011EFF01041201080D0110081001010F0F1210FC100802040402B207:205180000100011E080400008C00040004040400080804000C0C04001010040014140400C7:20520000181804001C1C0400202000081E080E000004770008000472000400000409000494:20528000000000080C08630004080083000801C8040800080400ED0E9C10000C0408010156:205300000501FA0004010D0101FA00104C1008000C04010101FA00100002100C010101FAD3:2053800010080E0000BF0021000C2C0400000401040C000C030C44000C010C000800020034:20540000000C001001100200000C0EF80000140101035900140100F808040401511408143A:20548000000004080C7E000000001001052A07F8F000140804000400140018101000040CC7:20550000080004000C0804A30000180C0154000F1808002D140000140C080400000120107E:2055800010A800040001C2103E00080001BB1031000C0002BCFF1014000E0804000004A688:20560000000800410400080000260E00080078000700320408550800E8000E700074B20053:205680001784040C0C04000800080009000100010C32010CE7B2010C2404E57058700001FD:2057000000CB68050672000406346D06306A8F700008083C0010E508756F0A65706EF01015:205780000000042C040004040C08000004080005000004080C04000004040C080C101E70C6:2058000000000101021401140610080300100C0C045A140006050A146C0101007000700029:205880001408040004F10C0C7E00080C00271000010B0C731000106F00D010001400004CB8:20590000040000D900080C04000A402C95000814FD08302CE400040800084C007C001E0824:20598000FBFE4C1000003C3C000001043C280000003C18003CE810A4B0ACA80E000001FF93:205A00000400080485000400019F08010804180004000195FF040E080000F200046C00000B:205A800001A50004020000019E00000401CA00000408010B010304FB03FF010101FB0001D0:205B0000010CFB0100EF01000C010CE71E08009800480000080800009700080800000003CC:205B800000F2006808D00E04000408790000880000003D1800040000B7000EFC100804007E:205C000004000C080000000401040004000400F2101E0E0004E000005800000400000800E5:205C8000000C000010000E0E04000099040C0700940014000400010000010E00140C080430:205D00000000040C4C101000080CF7100C14000800380000032800003C0000000C3C006F6E:205D800008C000140400000C0C04E500080404080000FF140000140400000C0C04D20008E9:205E00000404080000FF140000140400000C0C04BF00080404080000FF1400F800383001E0:205E8000059E0000F800063404F500F8C860001F1000242400071C00B8C001A5FE0000C49A:205F000000011E0001000101FA020101001E0101FC1E0044002C280A0004897204A528595C:205F80004400400E0400081800008C000000410004BD000E0E042800D2002000000408E592:20600000000E756FE80014100C0804040CC3000C1008042614000014100C08040404B2003F:206080000C1008041114000014080400040C8F080C0F00008914000E0004C0000087003AA1:206100000004000008000E0E04000408F400001B000401ED000E0E040004080300005A00BD:206180000401EA000E0E04000408F4000051000402ED000E0E0400001C0000040404E40080:206200000E280E0400003E000414000008086E0E001400000C9404010C8C04501400005C3F:20628000040008C20008F408CC5C00000800001810020004010004081E0E0000610404012B:2063000001010104010E0800001810020004010004081E0804000400000400040400081EC4:206380001008040000080000040400101E08040000180000040400081E300E080400000403:20640000D004080000D40E08000304040001040001081E08000304040001040001081E0838:20648000000004040001040001081E0E040004040C10040C00D90E00140C08040000040863:20650000BA14000100560002021E010101FB1E0800081E0E04000004000E080000140000AA:2065800004D40008500E04000413000800000E00080400000404000400081E08DC18010051:206600000000041908FF00FF0501010C1E01FA001E010101010C000100F80C1E08000000D2:206680000300CE00A7080800001000000001081E0E04000450040000BF0E080000000300F9:2067000045008908080000000300B8007F080E04000086040000470E080000000300440019:206780006B0800FFFF0C1E0001FA001E0E080400000408A80E0E080400000408450E0804E4:206800000004000000081E080000082D002A00080E080400040832000E14001E0C001E1EFF:20688000A8A40E0804000408380E0E0804000408430E0E08040004084E0E0800000100F04E:2069000000080E0400040000260E0E08040004088E0E080400040000081E0E0000040465B2:20698000040E0E0400008C0C310E010014040E011C20080000043600080E08040004CD0E55:206A00000E04000400DB0E0E08040004BF0E0E040004004D0E0E08040004B10E0E04000428:206A800000460E0E08040004A30E0E04000400270E0E040004A3000E0E040004A8000E0EE7:206B0000040004D1000E0E040004D0000E0E04000004830E0E0400045C000E100C0804004B:206B8000101E0E0400000CB20E0E0400000CAB0E03014C000C004403030004010C9E0101BB:206C0000010001FB1E0100010100FB1E08000014081E08000008C60808000000081E0800E7:206C80000002EF0808000001DD0808000004081E0E040004070E08040000081E0E04000468:206D0000FF0E08040000081E0E040004F70E08040000081E0E040004EF0E08040000081EA2:206D800008040000081E08040000081E0E0400043F0E0E040004CF0E0E0400043A0E0E04C9:206E00000004700E080000AC000808F104000818000808A0B7080E040004370E0E04000437:206E8000B00E08000008081E08000004081E080000E400080800008400080E040004140E0C:206F00000E040004900E0E040004990E0E0400041B0E10040008101E0E040000BD0E080092:206F800000C908080000E808080000E308080000ED08080000AF08080000081E080000083B:207000001E080000081E080000FA08080000081E080000CD0808000076080800F40008087D:2070800000910008080000081E08002D08080041080800081E0800CE080800E70808000888:1B7100001E0800081E0800081E0800081E001E1E1E011E060179DD061E7F1E35:209170004E5F61315F646E5F65664E5F61315F6373706E004E5F61315F6E5F65664E5F61AF:2091F000315F737969454E5F61315F7379694500EC049CB4DCF000CC4CC8704C4C00108C6D:20927000243C647800E02448247000BCC4D84C4C00F8486018880004546C4C4C00581CE8DA:2092F000488C0064101048A000705840485400E49060A8C46465202067536C747200536F63:209370006F61006C3C746C00480001F4316C6F763172536931726566536C637200ACD800E1:2093F00000B4547000C4687C00D498AC00DCE804001CC4C800349CA000407478004C4C5031:20947000316C446531736575317243693165647331447600537874005379690058B0045899:2094F00090CC58B00458A0BC587CCC58E4EC5808EC58C02858981C5870EC58D0E45854581C:209570005868583943693843733773003776003870388038A038A038C03894388838C038D5:0695F000D06804FF506585:029ACC00B0C028:209AD8000100000000000023252321242122B00000000000000000000000000000002200A8:0A9B5800C0C8DC0000B8D8C06808DF:00000001FF");
}

int main() {

	int a[2];
	a[0] = 1;
	a[1] = 2;

	address addr = (address)0x81000000;
	MemoryManager* mm = MemoryManager::getInstanceAt(addr);
	MessageQueue* mq = mm->getMessageQueue();
	Message* m1 = mm->createMessage(1, 2, a);
	Message* m2 = mm->createMessage(1, 2, a);

	mm->remove(m1);
	Message* m3 = mm->createMessage(1, 2, a);

	// Init the kernel
	init_kernel();
	
	// Stefans Audio-Tests
	//audio_test();

	// Task-Tests
	//tasks_test();

	loader_test();

	while(1) {
		for (int z = 0; z < 80000;) {
			z++;
		}
	}
	//return 0;
}
